name: Petstore API CI/CD (Local Build)

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
      - dev

jobs:
  build-and-test:
    name: Build Petstore API Locally and Run Java Tests
    runs-on: ubuntu-latest

    steps:
      # ✅ Step 1: Checkout Your Repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # ✅ Step 2: Clone Swagger Petstore API (Dynamic Branch Selection)
      - name: Clone Swagger Petstore API
        run: |
          git clone https://github.com/swagger-api/swagger-petstore.git
          cd swagger-petstore
          git checkout $(git branch -r | grep -E 'origin/(main|master)' | sed 's/origin\///' | head -n 1)

      # ✅ Step 3: Set Up Java Environment
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: maven

      # ✅ Step 4: Update Maven WAR Plugin
      - name: Update Maven WAR Plugin
        run: |
          cd swagger-petstore
          mvn versions:use-latest-versions -Dincludes=org.apache.maven.plugins:maven-war-plugin
          mvn versions:commit

      # ✅ Step 5: Build Swagger Petstore API
      - name: Build Petstore API
        run: |
          cd swagger-petstore
          mvn clean install -DskipTests

      # ✅ Step 6: Start Swagger Petstore API
      - name: Start Petstore API
        run: |
          cd swagger-petstore
          java -jar target/swagger-petstore-server.jar &
          sleep 20

      # ✅ Step 7: Verify Petstore API is Running
      - name: Verify Petstore API is Running
        run: |
          curl --retry 5 --retry-delay 5 --retry-connrefused http://localhost:8080/api/v3/openapi.json

      # ✅ Step 8: Install Dependencies for Tests
      - name: Install Maven Dependencies
        run: |
          cd swagger-petstore
          mvn clean install -DskipTests

      # ✅ Step 9: Run API Tests
      - name: Run Tests
        run: |
          cd swagger-petstore
          mvn test

      # ✅ Step 10: Upload Test Results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: swagger-petstore/target/surefire-reports

      # ✅ Step 11: Archive Swagger Petstore Logs
      - name: Archive Logs
        if: always()
        run: |
          docker ps -a
          docker logs $(docker ps -q -f ancestor=swaggerapi/petstore3) > petstore-api.log || echo "No container logs found"
        shell: bash

      # ✅ Step 12: Upload API Logs
      - name: Upload API Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: petstore-api-logs
          path: petstore-api.log
